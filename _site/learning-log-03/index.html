<!DOCTYPE html> <html lang="en-US"> <head prefix="og: http://ogp.me/ns#"> <meta charset="UTF-8" /> <meta http-equiv="X-UA-Compatible" content="ie=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <meta name="mobile-web-app-capable" content="yes" /> <meta name="apple-mobile-web-app-capable" content="yes" /> <meta name="application-name" content="Janessa Tran" /> <meta name="apple-mobile-web-app-status-bar-style" content="#fff" /> <meta name="apple-mobile-web-app-title" content="Janessa Tran" /> <title> Learning Log (03) - Rails AntiPatterns, Model layer code - Janessa Tran </title> <link rel="alternate" href="https://janessatran.com/learning-log-03/" hreflang="en-US" /> <link rel="canonical" href="https://janessatran.com/learning-log-03/" /> <meta name="description" content="Full-stack software engineer" /> <meta name="referrer" content="no-referrer-when-downgrade" /> <meta property="fb:app_id" content="" /> <meta property="og:site_name" content="Learning Log (03) - Rails AntiPatterns, Model layer code | " /> <meta property="og:title" content="Learning Log (03) - Rails AntiPatterns, Model layer code | " /> <meta property="og:type" content="website" /> <meta property="og:url" content="https://janessatran.com/learning-log-03/" /> <meta property="og:description" content="Full-stack software engineer" /> <meta property="og:image" content="https://janessatran.com/assets/img/me.png" /> <meta property="og:image:width" content="640" /> <meta property="og:image:height" content="640" /> <meta name="twitter:card" content="summary" /> <meta name="twitter:title" content="Learning Log (03) - Rails AntiPatterns, Model layer code | janessatran_" /> <meta name="twitter:url" content="https://janessatran.com/learning-log-03/" /> <meta name="twitter:site" content="@janessatran_" /> <meta name="twitter:creator" content="@janessatran_" /> <meta name="twitter:description" content="Full-stack software engineer" /> <meta name="twitter:image" content="https://janessatran.com/assets/img/me.png" /> <link type="application/atom+xml" rel="alternate" href="https://janessatran.com/feed.xml" title="Janessa Tran" /> <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicons/apple-touch-icon.png" /> <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicons/favicon-32x32.png" /> <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicons/favicon-16x16.png" /> <link rel="manifest" href="/assets/favicons/site.webmanifest" /> <link rel="mask-icon" href="/assets/favicons/safari-pinned-tab.svg" color="#5bbad5" /> <meta name="apple-mobile-web-app-title" content="Jekyll Klise" /> <meta name="application-name" content="Jekyll Klise" /> <meta name="msapplication-TileColor" content="#da532c" /> <meta name="theme-color" content="#2c2c2c" /> <link rel="stylesheet" href="/assets/css/style.css" /> </head> <body data-theme="dark" class="notransition"> <script> const body = document.body; const data = body.getAttribute("data-theme"); const initTheme = (state) => { if (state === "dark") { body.setAttribute("data-theme", "dark"); } else if (state === "light") { body.removeAttribute("data-theme"); } else { localStorage.setItem("theme", data); } }; initTheme(localStorage.getItem("theme")); setTimeout(() => body.classList.remove("notransition"), 75); </script> <div class="navbar" role="navigation"> <nav class="menu"> <input type="checkbox" id="menu-trigger" class="menu-trigger" /> <label for="menu-trigger"> <span class="menu-icon"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512"> <path d="M64,384H448V341.33H64Zm0-106.67H448V234.67H64ZM64,128v42.67H448V128Z" /> </svg> </span> </label> <a id="mode"> <svg class="mode-sunny" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512"> <title>LIGHT</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> <svg class="mode-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512"> <title>DARK</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> </a> <div class="trigger"> <div class="trigger-container"><a class="menu-link" href="/">home</a><a class="menu-link" href="/archive/">archive</a><a class="menu-link" href="/projects/">projects</a><a class="menu-link rss" href="/feed.xml"> <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 512 512" fill="#ED812E"> <title>RSS</title> <path d="M108.56,342.78a60.34,60.34,0,1,0,60.56,60.44A60.63,60.63,0,0,0,108.56,342.78Z" /> <path d="M48,186.67v86.55c52,0,101.94,15.39,138.67,52.11s52,86.56,52,138.67h86.66C325.33,312.44,199.67,186.67,48,186.67Z" /> <path d="M48,48v86.56c185.25,0,329.22,144.08,329.22,329.44H464C464,234.66,277.67,48,48,48Z" /> </svg> </a> </div> </div> </nav> </div> <div class="wrapper post"> <main class="page-content" aria-label="Content"> <article itemscope itemtype="https://schema.org/BlogPosting"> <header class="header"> <div class="tags"> <span itemprop="keywords"> <a class="tag" href="/tags/#ruby-on-rails">RUBY ON RAILS</a> </span> </div> <h1 class="header-title" itemprop="headline">Learning Log (03) - Rails AntiPatterns, Model layer code</h1> <div class="post-meta"> <time datetime="2019-11-10T00:00:00-08:00" itemprop="datePublished"> Nov 10, 2019 </time> <span itemprop="author" itemscope itemtype="https://schema.org/Person"> <span itemprop="name">Janessa Tran</span> </span> <time hidden datetime="" itemprop="dateModified"> Nov 10, 2019 </time> <span hidden itemprop="publisher" itemtype="Person">Janessa Tran</span> <span hidden itemprop="image"></span> <span hidden itemprop="mainEntityOfPage"><p>Today I started reading a book called “Rails AntiPatterns, Best Practice Ruby on Rails Refactoring”. My goal with reading this book is to get a better sense of how to write more organized, clean code that makes sense to other people and is easier to maintain. In this post, I will share what I learned today from the book!</p> </span> </div> </header> <div class="page-content" itemprop="articleBody"> <p>Today I started reading a book called “Rails AntiPatterns, Best Practice Ruby on Rails Refactoring”. My goal with reading this book is to get a better sense of how to write more organized, clean code that makes sense to other people and is easier to maintain. In this post, I will share what I learned today from the book!</p> <h2 id="follow-the-law-of-demeter-aka-use-only-one-dot"> <a href="#follow-the-law-of-demeter-aka-use-only-one-dot" class="anchor-head"></a> Follow the Law of Demeter, aka, “use only one dot”. </h2> <p>This law describes the concept that an object can call methods on a related object, but it should not reach through that object to call a method on a third related object.</p> <p>Example: Say that you have created a Rails app with different models like the following…</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Library</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
  <span class="n">has_one</span> <span class="ss">:address</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:library</span>
  <span class="n">has_one</span> <span class="ss">:genre</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Address</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:library</span>
<span class="k">end</span>
</code></pre></div></div> <p>If we were to show a view of the data above (a book of a specific genre, available at a specific library, which is at a specific address) it might look something like:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># library_books.html.erb

&lt;%= @book.genre %&gt;
&lt;%= @book.library.name %&gt;
&lt;%= @book.library.address.street %&gt;
&lt;%= @book.library.address.city %&gt;
&lt;%= @book.library.address.state %&gt;
&lt;%= @book.library.address.zip_code %&gt;
</code></pre></div></div> <p>This violates the Law of Demeter because we have to access information through associations of other models (we don’t just use one “dot”). This is not ideal because the list of dependencies makes the code more fragile in the case that one of the association’s changes. For example, what would happen if we wanted to change <code class="language-plaintext highlighter-rouge">address</code> to <code class="language-plaintext highlighter-rouge">location</code>? We’d have to go through our code and find every call to <code class="language-plaintext highlighter-rouge">address</code> and change it! I mean, it’s possible, but kind of a lot of work.</p> <p>Luckily, Rails enables us to easily address this concern with the <code class="language-plaintext highlighter-rouge">delegate</code> method. In short, delegation allows us to use methods of one object from another by “delegating” them from one class to another.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Library</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
  <span class="n">has_one</span> <span class="ss">:address</span>

  <span class="n">delegate</span> <span class="ss">:city</span><span class="p">,</span> <span class="ss">:street</span><span class="p">,</span> <span class="ss">:state</span><span class="p">,</span> <span class="ss">:zip_code</span><span class="p">,</span> <span class="ss">to: :address</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span>
  <span class="n">belongs_to</span> <span class="ss">:library</span>
  <span class="n">has_one</span> <span class="ss">:genre</span>

  <span class="n">delegate</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:city</span><span class="p">,</span> <span class="ss">:street</span><span class="p">,</span> <span class="ss">:state</span><span class="p">,</span> <span class="ss">:zip_code</span><span class="p">,</span> <span class="ss">to: :library</span><span class="p">,</span> <span class="ss">prefix: </span><span class="s1">'library'</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Address</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:library</span>
<span class="k">end</span>
</code></pre></div></div> <p>Looking at the <code class="language-plaintext highlighter-rouge">Library</code> model, we’ve set up a delegation such that we can now call <code class="language-plaintext highlighter-rouge">:city, :street, :state, :zip_code</code> from a <code class="language-plaintext highlighter-rouge">Library</code> object directly. The <code class="language-plaintext highlighter-rouge">delegate</code>method passes all those method calls to <code class="language-plaintext highlighter-rouge">address</code>, which we have through the <code class="language-plaintext highlighter-rouge">has_one</code> association. If we call <code class="language-plaintext highlighter-rouge">current_library.street</code>, for example, it will be translated to <code class="language-plaintext highlighter-rouge">current_library.address.street</code> since we’ve delegated <code class="language-plaintext highlighter-rouge">street</code> to call <code class="language-plaintext highlighter-rouge">address</code>.</p> <p>Another way to think about this, if the above doesn’t make sense, is reading it like: “hey <code class="language-plaintext highlighter-rouge">Book</code> objects, if you get a call to <code class="language-plaintext highlighter-rouge">:street</code>, we are delegating it to <code class="language-plaintext highlighter-rouge">Library</code>”.</p> <h2 id="push-all-calls-to-find-into-finders-in-the-model"> <a href="#push-all-calls-to-find-into-finders-in-the-model" class="anchor-head"></a> Push all calls to find() into Finders in the Model </h2> <p>In short, don’t have any logic in the presentation layer (views).</p> <p>Example: say you want to display a page of users of your application by order of last name.</p> <div class="language-haml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">-# index.haml
</span>
<span class="nf">#user-list</span>
  <span class="nt">%h1</span> Users
  <span class="p">-</span> <span class="no">User</span><span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="ss">:last_name</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">u</span><span class="o">|</span>
    <span class="nt">%li</span> link_to u.profile, u.full_name
</code></pre></div></div> <p>Instead of having the logic directly in the view, it’s better to put it in the Controller and Model. If we wanted to list the users by order of last name again, we would need to repeat this logic and repeating code is not ideal (more about the DRY concept can be found <a href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself">here</a>.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@users</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">ordered_by_last_name</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>We can use a <code class="language-plaintext highlighter-rouge">scope</code>, which enables us to specify commonly-used queries as method calls on objects:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">scope</span> <span class="ss">:ordered_by_last_name</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="ss">title: </span><span class="n">asc</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div> <p>Now, in our view, we can do:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">-</span><span class="c1"># index.haml</span>

<span class="c1">#user-list</span>
  <span class="o">%</span><span class="n">h1</span> <span class="no">Users</span>
  <span class="o">-</span> <span class="vi">@users</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">u</span><span class="o">|</span>
    <span class="o">%</span><span class="n">li</span> <span class="n">link_to</span> <span class="n">u</span><span class="p">.</span><span class="nf">profile</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="nf">full_name</span>
</code></pre></div></div> <h2 id="keep-finders-in-their-own-model"> <a href="#keep-finders-in-their-own-model" class="anchor-head"></a> Keep Finders in Their Own Model </h2> <p>Finder are calls that query the database. For example, say we have a model <code class="language-plaintext highlighter-rouge">User</code> and <code class="language-plaintext highlighter-rouge">Orders</code> and wanted to <strong>find</strong> all of a user’s orders that have just been created. That query finder would look something like:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="vi">@orders</span> <span class="o">=</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">orders</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">status: </span><span class="n">created</span><span class="p">,</span> <span class="n">created_at</span> <span class="mi">2</span><span class="p">.</span><span class="nf">days</span><span class="p">.</span><span class="nf">ago</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>We can improve this code by moving the finder (of created orders) inside the <code class="language-plaintext highlighter-rouge">Order</code> model. This will make the <code class="language-plaintext highlighter-rouge">UsersController</code> thinner and clarify what it’s doing with a semantic method name defined in the <code class="language-plaintext highlighter-rouge">Orders</code> model.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="vi">@recently_created_orders</span> <span class="o">=</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">find_created_orders</span>
  <span class="k">end</span> 
<span class="k">end</span>

<span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:orders</span>

  <span class="k">def</span> <span class="nf">find_created_orders</span>
    <span class="n">orders</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">status: </span><span class="n">created</span><span class="p">,</span> <span class="n">created_at</span> <span class="mi">2</span><span class="p">.</span><span class="nf">days</span><span class="p">.</span><span class="nf">ago</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>But.. wait!! We can improve this even more. Active Record associations give us a proxy class that act like arrays and lets us access methods on the target class. This means that if we had a method like <code class="language-plaintext highlighter-rouge">Order.recently_created</code> we could use it through our associations, <code class="language-plaintext highlighter-rouge">user.orders.recently_created</code>.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="vi">@recently_created_orders</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">recently_created_orders</span>
  <span class="k">end</span> 
<span class="k">end</span>

<span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:orders</span>

  <span class="k">def</span> <span class="nf">recently_created_orders</span>
    <span class="n">orders</span><span class="p">.</span><span class="nf">recently_created</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">recently_created</span>
    <span class="p">(</span><span class="ss">status: </span><span class="n">created</span><span class="p">,</span> <span class="n">created_at</span> <span class="mi">2</span><span class="p">.</span><span class="nf">days</span><span class="p">.</span><span class="nf">ago</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>This finder object pattern helps keep the model logic strictly related to a class’ behavior, unlike before when we had a query for <code class="language-plaintext highlighter-rouge">Order</code> in our <code class="language-plaintext highlighter-rouge">User</code> controller. It also helps keep the controller’s skinny.</p> </div> </article> </main> <nav class="post-nav"> <a class="post-nav-item post-nav-prev" href="/learning-log-02/" > <div class="nav-arrow">Previous</div> <span class="post-title">Learning Log (02) - `chmod` and binary</span> </a> <a class="post-nav-item post-nav-next" href="/learning-log-04/"> <div class="nav-arrow">Next</div> <span class="post-title">Learning Log (04) - Rails AntiPatterns, Using modules and classes</span> </a> </nav> <footer class="footer"> <a class="footer_item" href="/thanks">ack.</a> <!-- <a class="footer_item" href="/assets/resume.pdf" download>resume</a> --> <a class="footer_item" href="/feed.xml">rss</a> <span class="footer_item">&copy; 2023</span> <small class="footer_copyright"> <!-- Klisé Theme: https://github.com/piharpi/jekyll-klise --> <a href="https://github.com/piharpi/jekyll-klise" target="_blank" rel="noreferrer noopener" >klisé</a > theme on <a href="https://jekyllrb.com" target="_blank" rel="noreferrer noopener" >jekyll</a > </small> </footer> <script src="/assets/js/main.js" defer="defer"></script> </div> </body> </html>
